From 8e8269a41a5f787632a50d3de1cab02e2cd8ec16 Mon Sep 17 00:00:00 2001
From: Rachel Menge <rachelmenge@microsoft.com>
Date: Wed, 12 Nov 2025 16:22:11 -0800
Subject: [PATCH] Fix ANSI escape filtering to handle OSC 3008 audit logs from
 systemd 258

Fedora 43 (systemd 258) introduces OSC (Operating System Command) 3008
ANSI escape sequences for sudo audit logging when PTY is allocated.
These sequences appear in command output and break regex parsing in tools
like lspci.

OSC sequences have format: ESC ] <data> BEL  or  ESC ] <data> ESC Example: \x1b]3008;start=UUID;user=name;hostname=host;...\x1b
The previous regex pattern had a character class bug: the range \-_
(0x5c-0x5f) inadvertently included ] (0x5d), causing the regex to match
ESC and ] as separate characters instead of recognizing the full OSC
sequence.

Changes:
- Reordered alternation to match OSC pattern first, preventing premature
  matching by the single-character escape range
  detecting ESC \ terminator
- Supports both BEL (0x07) and ST (ESC \, 0x1b 0x5c) terminators

Tested with:
- OSC 3008 sequences from Fedora 43 systemd 258
- CSI sequences (existing functionality)
- Single-character escapes (existing functionality)
- Both BEL and ST terminators

This fix maintains backward compatibility with existing ANSI escape
filtering while handling modern systemd audit logging.
---
 lisa/util/__init__.py | 45 ++++++++++++++++++++++++++++++++++++++-----
 1 file changed, 40 insertions(+), 5 deletions(-)

diff --git a/lisa/util/__init__.py b/lisa/util/__init__.py
index 77df84c06..5579ba84e 100644
--- a/lisa/util/__init__.py
+++ b/lisa/util/__init__.py
@@ -62,11 +62,46 @@ __url_pattern = re.compile(
 )
 
 
-# used to filter ansi escapes for better layout in log and other place
-# Example:
-# Text: "\x1b[?1h\x1b=\rAdd linux-next specific files for 20230221\x1b[m\r\n\r\x1b[K\x1b[?1l\x1b>"  # noqa: E501
-# Escape Result: '\rAdd linux-next specific files for 20230221\r\n\r'
-__ansi_escape = re.compile(r"\x1B(?:[@-Z\\-_=<>a-kzNM78]|\[[0-?]*[ -/]*[@-~])")
+# Used to filter ANSI escape sequences for better layout in logs and other output.
+# ANSI escapes are special character sequences that control terminal behavior
+# (colors, cursor movement, etc.) but interfere with text parsing.
+#
+# Examples of sequences we filter:
+# 1. CSI (Control Sequence Introducer): "\x1b[31m" (red color), "\x1b[2J" (clear screen)
+# 2. OSC (Operating System Command): "\x1b]0;Title\x07" (set window title)
+# 3. OSC 3008 audit logs: "\x1b]3008;user=test;...\x1b\" (sudo audit from systemd 258+)
+# 4. Single-char escapes: "\x1bM" (reverse line feed), "\x1b7" (save cursor)
+#
+# Note: This regex captures the most common ANSI sequences encountered in terminal output.
+# It does NOT capture all possible ANSI escapes (e.g., DCS, PM, APC sequences), but it
+# handles the sequences that typically appear in command output and logs. For LISA's
+# use case (filtering terminal output for parsing), this provides sufficient coverage.
+#
+# Pattern breakdown (order matters - OSC must come first!):
+# 1. OSC sequences: ESC ] <data> (BEL|ESC\)
+#    - Matches: \x1b]...\x07 or \x1b]...\x1b\
+#    - Must be first to prevent ']' from matching in single-char range
+# 2. Single-char escapes: ESC followed by one character from [@-Z\\-_=<>a-kzNM78]
+#    - Matches: \x1b7, \x1bM, etc.
+# 3. CSI sequences: ESC [ <params> <command>
+#    - Matches: \x1b[31m, \x1b[2J, etc.
+__ansi_escape = re.compile(
+    r"\x1B(?:"  # Start: ESC character followed by one of three patterns
+    # Pattern 1: OSC (Operating System Command) - ESC ] <data> <terminator>
+    r"\]"  # Literal ']' character after ESC
+    r"(?:[^\x07\x1B]|\x1B(?!\\))*"  # Data: any char except BEL/ESC, or ESC not followed by \
+    r"(?:\x07|\x1B\\)"  # Terminator: BEL (\x07) or ST (ESC \)
+    r"|"  # OR
+    # Pattern 2: Single-character escapes - ESC <char>
+    r"[@-Z\\-_=<>a-kzNM78]"  # One character from these ranges
+    r"|"  # OR
+    # Pattern 3: CSI (Control Sequence Introducer) - ESC [ <params> <final>
+    r"\["  # Literal '[' character after ESC
+    r"[0-?]*"  # Parameter bytes (optional)
+    r"[ -/]*"  # Intermediate bytes (optional)
+    r"[@-~]"  # Final byte (required)
+    r")"  # End of alternation
+)
 
 # 10.0.22000.100
 # 18.04.5
-- 
2.51.0

