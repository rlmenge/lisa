From b4c4430f4ae28172d8408588ed0522ad2dd7fa5f Mon Sep 17 00:00:00 2001
From: Lili Deng <lildeng@microsoft.com>
Date: Wed, 26 Nov 2025 12:14:46 +0800
Subject: [PATCH] xdpdump: fix compile error

---
 lisa/microsoft/testsuites/xdp/xdpdump.py |  8 +++++
 lisa/tools/lagscope.py                   | 37 ++++++++++++------------
 2 files changed, 26 insertions(+), 19 deletions(-)

diff --git a/lisa/microsoft/testsuites/xdp/xdpdump.py b/lisa/microsoft/testsuites/xdp/xdpdump.py
index d89ed889c..58f1a1c4a 100644
--- a/lisa/microsoft/testsuites/xdp/xdpdump.py
+++ b/lisa/microsoft/testsuites/xdp/xdpdump.py
@@ -101,6 +101,14 @@ class XdpDump(Tool):
             sudo=True,
         )
 
+        # Fix Makefile compilation rule
+        sed.substitute(
+            "-O2 -emit-llvm -c -g \\$<",
+            "-O2 -emit-llvm -g $< -o ${<:.c=.ll}",
+            f"{self._code_path}/Makefile",
+            sudo=True,
+        )
+
         # create a default version for exists checking.
         make = self.node.tools[Make]
         make.make(
diff --git a/lisa/tools/lagscope.py b/lisa/tools/lagscope.py
index b93c62341..28f4e781b 100644
--- a/lisa/tools/lagscope.py
+++ b/lisa/tools/lagscope.py
@@ -266,54 +266,52 @@ class Lagscope(Tool, KillableMixin):
 
         metrics = [
             {
-                "name": "min_latency",
+                "name": (
+                    f"min_latency_interval_{int(interval_us)}_freq_{int(frequency)}"
+                ),
                 "value": float(min_latency_us),
                 "unit": "microseconds",
                 "description": "Minimum latency",
                 "relativity": MetricRelativity.LowerIsBetter,
             },
             {
-                "name": "max_latency",
+                "name": (
+                    f"max_latency_interval_{int(interval_us)}_freq_{int(frequency)}"
+                ),
                 "value": float(max_latency_us),
                 "unit": "microseconds",
                 "description": "Maximum latency",
                 "relativity": MetricRelativity.LowerIsBetter,
             },
             {
-                "name": "average_latency",
+                "name": (
+                    f"average_latency_interval_{int(interval_us)}_freq_{int(frequency)}"
+                ),
                 "value": float(average_latency_us),
                 "unit": "microseconds",
                 "description": "Average latency",
                 "relativity": MetricRelativity.LowerIsBetter,
             },
             {
-                "name": "latency_95th_percentile",
+                "name": (
+                    "latency_95th_percentile_interval_"
+                    f"{int(interval_us)}_freq_{int(frequency)}"
+                ),
                 "value": float(latency95_percentile_us),
                 "unit": "microseconds",
                 "description": "95th percentile latency",
                 "relativity": MetricRelativity.LowerIsBetter,
             },
             {
-                "name": "latency_99th_percentile",
+                "name": (
+                    "latency_99th_percentile_interval_"
+                    f"{int(interval_us)}_freq_{int(frequency)}"
+                ),
                 "value": float(latency99_percentile_us),
                 "unit": "microseconds",
                 "description": "99th percentile latency",
                 "relativity": MetricRelativity.LowerIsBetter,
             },
-            {
-                "name": "interval_us",
-                "value": float(interval_us),
-                "unit": "microseconds",
-                "description": "Test interval",
-                "relativity": MetricRelativity.Parameter,
-            },
-            {
-                "name": "frequency",
-                "value": float(frequency),
-                "unit": "Hz",
-                "description": "Test frequency",
-                "relativity": MetricRelativity.Parameter,
-            },
         ]
 
         for metric in metrics:
@@ -322,6 +320,7 @@ class Lagscope(Tool, KillableMixin):
             metric_unit: str = metric["unit"]  # type: ignore
             metric_description: str = metric["description"]  # type: ignore
             metric_relativity: MetricRelativity = metric["relativity"]  # type: ignore
+
             send_unified_perf_message(
                 node=self.node,
                 test_result=test_result,
-- 
2.51.0

